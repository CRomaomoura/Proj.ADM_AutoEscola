
--CRIANDO A BASE DE DADOS
CREATE DATABASE ADM_AUTOESCOLA;

-- CRIANDO AS TABELAS

--NOS CAMPOS QUE TENHO COMO PRE-DEFINIDOS USAREI O TIPO ENUM PARA POVOAMENTO
--AS CHAVES PRIMARIAS SERÃO SERIAL (AUTO-INCREMENTO), POREM EU MESMO AS DEFINO A SEQUENCIA

CREATE TYPE GENERO AS ENUM('MASCULINO','FEMININO'); --DEFININDO UM TIPO ENUM
CREATE SEQUENCE seq_id_clientes INCREMENT 1 MINVALUE 1 MAXVALUE 999999999999999999 START 1 CACHE 1; --CRIANDO UMA SEQUENCIA
CREATE TABLE CLIENTE (
	IDCLIENTE INT PRIMARY KEY DEFAULT nextval('seq_id_clientes'),-- ATRIBUINDO A SEQUENCIA AO CAMPO QUE TERÁ AUTO INCREMENTO
	NOME VARCHAR(100) NOT NULL ,
	SOBRENOME VARCHAR(150) NOT NULL,
	SEXO GENERO NOT NULL,
	CPF VARCHAR(14) NOT NULL UNIQUE,
	PROFISSAO VARCHAR(50) NOT NULL,
	ESCOLARIDADE VARCHAR(50) NOT NULL,
	ESTADO_CIVIL VARCHAR(50) NOT NULL,
	EMAIL VARCHAR(100) UNIQUE
);

CREATE TYPE ORIGEM AS ENUM('BRASILEIRO','ESTRANGEIRO','NATURALIZADO');
CREATE SEQUENCE seq_id_rgs INCREMENT 1 MINVALUE 1 MAXVALUE 999999999999999999 START 1 CACHE 1;
CREATE TABLE RG (
	IDRG INT PRIMARY KEY DEFAULT NEXTVAL('seq_id_rgs'),
	NUMERO VARCHAR(30) NOT NULL,
	DATA_EMISSAO DATE NOT NULL,
	ORGAO_EMISSOR VARCHAR(10) NOT NULL,
	DATA_NASCIMENTO DATE NOT NULL,
	LOCAL_NASCIMENTO VARCHAR(50) NOT NULL,
	NATURALIDADE ORIGEM NOT NULL,
	NOME_MAE VARCHAR(255) NOT NULL,
	NOME_PAI VARCHAR(255) 
);

CREATE SEQUENCE seq_id_end INCREMENT 1 MINVALUE 1 MAXVALUE 999999999999999999 START 1 CACHE 1;  
CREATE TABLE ENDERECO (
	IDENDERECO  INT PRIMARY KEY DEFAULT NEXTVAL('seq_id_end'),
	RUA VARCHAR(100)  NOT NULL,
	NUMERO VARCHAR(10) NOT NULL,
	BAIRRO VARCHAR(50) NOT NULL,
	CIDADE VARCHAR(50) NOT NULL,
	ESTADO CHAR(2) NOT NULL
);

CREATE TYPE CURSAR AS ENUM('TEORICO','PRATICO','PRATICO/TEORICO');
CREATE TYPE SERVICO AS ENUM('1ª HABILITACAO','ADICAO','MUDANCA');
CREATE TYPE CAT AS ENUM('A','B','C','D','E','AB','AC','AD','AE');
CREATE SEQUENCE seq_id_catpret INCREMENT 1 MINVALUE 1 MAXVALUE 999999999999999999 START 1 CACHE 1; 
CREATE TABLE CATEGORIA_PRETENDIDA(
	IDCAT_PRET INT PRIMARY KEY DEFAULT NEXTVAL('seq_id_catpret'),
	CURSO  CURSAR NOT NULL,
	TIPO SERVICO NOT NULL,
	CATEGORIA CAT NOT NULL
);

CREATE TYPE CONTATO AS ENUM('CELULAR','FIXO','COMERCIAL');
CREATE SEQUENCE seq_id_telefones INCREMENT 1 MINVALUE 1 MAXVALUE 999999999999999999 START 1 CACHE 1; 
CREATE TABLE TELEFONE (
	IDTELEFONE INT PRIMARY KEY DEFAULT NEXTVAL('seq_id_telefones'),
	TIPO CONTATO NOT NULL,
	NUMERO VARCHAR(15) NOT NULL
);


CREATE TYPE FP AS ENUM('AVISTA','CARTAO','OUTROS');
CREATE SEQUENCE seq_id_pg INCREMENT 1 MINVALUE 1 MAXVALUE 999999999999999999 START 1 CACHE 1; 
CREATE TABLE FORMA_PAGTO(
	IDPAGTO INT PRIMARY KEY DEFAULT NEXTVAL('seq_id_pg'),
	FORMA FP NOT NULL,
	VALOR MONEY NOT NULL,
	DATA_PAGTO TIMESTAMP
	);
-- FIM DA CRIAÇÃO DE TABELAS
	
--CRIANDO UMA PROCEDURE PARA A TABELA FORMA_PAGTO
CREATE FUNCTION GERA_DATA_HORA() RETURNS TRIGGER AS $$
BEGIN

	UPDATE FORMA_PAGTO SET DATA_PAGTO = NOW();
	RETURN NEW;

END;
$$ LANGUAGE 'plpgsql';

-- CRIANDO O GATILHO PARA A PROCEDURE

CREATE TRIGGER ADD_DATA_HORA
AFTER INSERT ON FORMA_PAGTO
FOR EACH ROW
EXECUTE PROCEDURE GERA_DATA_HORA();

/* INSERINDO AS REFERENCIAS*/ 
--fiz a criação das chaves estrangerias após a criação das tabelas para evitar conflito no momento da criação das tabelas

ALTER TABLE RG ADD RG_CLIENTE INT NOT NULL;
ALTER TABLE RG ADD CONSTRAINT RG_CLIENTE_CLIENTE FOREIGN KEY (RG_CLIENTE) REFERENCES CLIENTE(IDCLIENTE);

ALTER TABLE ENDERECO ADD ENDERECO_CLIENTE INT NOT NULL;
ALTER TABLE ENDERECO ADD CONSTRAINT END_CLIENTE_CLIENTE FOREIGN KEY (ENDERECO_CLIENTE) REFERENCES CLIENTE(IDCLIENTE);

ALTER TABLE CATEGORIA_PRETENDIDA ADD CATEGORIA_CLIENTE INT NOT NULL;
ALTER TABLE CATEGORIA_PRETENDIDA ADD CONSTRAINT CAT_CLIENTE_CLIENTE FOREIGN KEY (CATEGORIA_CLIENTE) REFERENCES CLIENTE(IDCLIENTE);

ALTER TABLE TELEFONE ADD CONTATO_CLIENTE INT NOT NULL;
ALTER TABLE TELEFONE ADD CONSTRAINT CONTATO_CLIENTE_CLIENTE FOREIGN KEY (CONTATO_CLIENTE) REFERENCES CLIENTE(IDCLIENTE);

ALTER TABLE FORMA_PAGTO ADD PAGTO_CLIENTE INT NOT NULL;
ALTER TABLE FORMA_PAGTO ADD CONSTRAINT PG_CLIENTE_CLIENTE FOREIGN KEY (PAGTO_CLIENTE) REFERENCES CLIENTE(IDCLIENTE);

--POVOADO AS TABELAS

-- INSERINDO CLIENTES
	INSERT INTO CLIENTE (nome, sobrenome, sexo, cpf, profissao, escolaridade,estado_civil, email) 
	VALUES('Cicero Romão','de Moura Silva','MASCULINO','058.624.714-30','INSTRUTOR','SUPERIOR INCOMPLETO','CASADO','ROMAO@GMAIL.COM');
	
	INSERT INTO CLIENTE (nome, sobrenome, sexo, cpf, profissao, escolaridade,estado_civil, email) 
	VALUES('Romão moura','da Silva','MASCULINO','099.644.714-30','estudante','SUPERIOR INCOMPLETO','CASADO','ROMAOMOURA@GMAIL.COM');
--FIM DO INSERIR CLIENTE

-- INSERINDO RG
	INSERT INTO RG (numero, data_emissao, orgao_emissor, data_nascimento, local_nascimento, naturalidade,nome_mae, nome_pai, rg_cliente) 
	VALUES('9089988787','2008-03-22','SSP-PE','1988-03-08','OURICURI-PE','BRASILEIRO','MARIA DA PAZ','JOAO DA CONCEICAO', 1);
	
	INSERT INTO RG (numero, data_emissao, orgao_emissor, data_nascimento, local_nascimento, naturalidade,nome_mae, nome_pai, rg_cliente) 
	VALUES('1089988787','2009-03-22','SSP-PE','1990-03-08','OURICURI-PE','BRASILEIRO','DAPAZ CORTE DE MOURA', 2);
--FIM DO INSERIR RG

-- INSERINDO ENDERECO
	INSERT INTO ENDERECO (RUA, NUMERO, BAIRRO, CIDADE, ESTADO, ENDERECO_CLIENTE) 
	VALUES('RUA JOAO PEREIRA DE CARVALHO','1485','CAMPO ALEGRE','JUAZEIRO DO NORTE','CE',1);
	
	INSERT INTO ENDERECO (RUA, NUMERO, BAIRRO, CIDADE, ESTADO, ENDERECO_CLIENTE) 
	VALUES('RUA JOSE PEREIRA DE CARVALHO','1585','CAMPO ALEGRE','JUAZEIRO DO NORTE','CE',2);
--FIM DO INSERIR ENDERECO

-- INSERINDO CATEGORIA_PRETENDIDA
	INSERT INTO CATEGORIA_PRETENDIDA (CURSO, TIPO, CATEGORIA, CATEGORIA_CLIENTE) 
	VALUES('PRATICO','MUDANCA','E',1);
	
	INSERT INTO CATEGORIA_PRETENDIDA (CURSO, TIPO, CATEGORIA, CATEGORIA_CLIENTE) 
	VALUES('PRATICO','MUDANCA','D',2);
--FIM DO INSERIR CATEGORIA_PRETENDIDA

-- INSERINDO TELEFONE
	INSERT INTO TELEFONE (TIPO,NUMERO, CONTATO_CLIENTE) 
	VALUES('CELULAR','(88) 999859218',1);
	
	INSERT INTO TELEFONE (TIPO,NUMERO, CONTATO_CLIENTE) 
	VALUES('CELULAR','(88) 999849219',2);
--FIM DO INSERIR TELEFONE

-- INSERINDO FORMA_PAGTO
	INSERT INTO FORMA_PAGTO (FORMA,VALOR,PAGTO_CLIENTE) 
	VALUES('AVISTA',1700,1);
	
	INSERT INTO FORMA_PAGTO (FORMA,VALOR,PAGTO_CLIENTE) 
	VALUES('AVISTA',1600,2);
--FIM DO INSERIR FORMA_PAGTO

--JUNTANDO TODAS AS TABELAS NO SELECT, COM O INNER JOIN.
SELECT C.NOME || '  ' || C.SOBRENOME AS "Nome Completo",C.CPF, -- USANDO A CONCATENAÇÃO DE CAMPOS PARA UM UNICO CAMPO
		R.NUMERO AS IDENTIDADE, R.NOME_MAE AS "Nome da mãe", COALESCE(R.NOME_PAI, 'Desconhecido') AS "Nome do pai", --A FUNÇÃO COALESCE VERIFICA SE O CAMPO É NULO E INSERE O VALOR CASO SEJA.
		E.RUA AS "Logradouro",E.NUMERO,E.BAIRRO,
		T.NUMERO AS TELEFONE,
		CP.TIPO AS CATEGORIA,
		FP.FORMA AS Pagamento,FP.VALOR 
		FROM CLIENTE C
		INNER JOIN RG R ON R.RG_CLIENTE = C.IDCLIENTE
		INNER JOIN ENDERECO E ON E.ENDERECO_CLIENTE = C.IDCLIENTE
		INNER JOIN TELEFONE T ON T.CONTATO_CLIENTE = C.IDCLIENTE
		INNER JOIN CATEGORIA_PRETENDIDA CP ON CP.CATEGORIA_CLIENTE = C.IDCLIENTE
		INNER JOIN FORMA_PAGTO FP ON FP.PAGTO_CLIENTE = C.IDCLIENTE;
-- FIM DA JUNÇÃO

--CRIANDO UMA VIEW 
CREATE VIEW V_RELATORIO AS
SELECT C.NOME || '  ' || C.SOBRENOME as "Nome Completo",
		C.CPF,R.NUMERO AS IDENTIDADE,
		R.NOME_MAE || '  e  '  || R.NOME_PAI AS "Filiação",
		E.RUA || ', ' || E.NUMERO || ', ' ||E.BAIRRO AS "Endereço",
		T.NUMERO AS TELEFONE,
		CP.TIPO AS CATEGORIA,
		FP.FORMA AS Pagamento,FP.VALOR 
		FROM CLIENTE C
		INNER JOIN RG R ON R.RG_CLIENTE = C.IDCLIENTE
		INNER JOIN ENDERECO E ON E.ENDERECO_CLIENTE = C.IDCLIENTE
		INNER JOIN TELEFONE T ON T.CONTATO_CLIENTE = C.IDCLIENTE
		INNER JOIN CATEGORIA_PRETENDIDA CP ON CP.CATEGORIA_CLIENTE = C.IDCLIENTE
		INNER JOIN FORMA_PAGTO FP ON FP.PAGTO_CLIENTE = C.IDCLIENTE;
