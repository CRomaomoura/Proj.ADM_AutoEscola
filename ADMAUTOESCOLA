CREATE DATABASE ADM_AUTOESCOLA;

CREATE TYPE GENERO AS ENUM('MASCULINO','FEMININO');
CREATE SEQUENCE seq_id_clientes INCREMENT 1 MINVALUE 1 MAXVALUE 999999999999999999 START 1 CACHE 1; 
CREATE TABLE CLIENTE (
	IDCLIENTE INT PRIMARY KEY DEFAULT nextval('seq_id_clientes'),
	NOME VARCHAR(100) NOT NULL ,
	SOBRENOME VARCHAR(150) NOT NULL,
	SEXO GENERO NOT NULL,
	CPF VARCHAR(14) NOT NULL UNIQUE,
	PROFISSAO VARCHAR(50) NOT NULL,
	ESCOLARIDADE VARCHAR(50) NOT NULL,
	ESTADO_CIVIL VARCHAR(50) NOT NULL,
	EMAIL VARCHAR(100) UNIQUE
);

-- INSERINDO CLIENTES
	INSERT INTO CLIENTE (nome, sobrenome, sexo, cpf, profissao, escolaridade,estado_civil, email) 
	VALUES('Cicero Romão','de Moura Silva','MASCULINO','088.644.714-30','INSTRUTOR','SUPERIOR INCOMPLETO','CASADO','ROMAO@GMAIL.COM');
--FIM DO INSERIR CLIENTE

CREATE TYPE ORIGEM AS ENUM('BRASILEIRO','ESTRANGEIRO','NATURALIZADO');
CREATE SEQUENCE seq_id_rgs INCREMENT 1 MINVALUE 1 MAXVALUE 999999999999999999 START 1 CACHE 1;
CREATE TABLE RG (
	IDRG INT PRIMARY KEY DEFAULT NEXTVAL('seq_id_rgs'),
	NUMERO VARCHAR(30) NOT NULL,
	DATA_EMISSAO DATE NOT NULL,
	ORGAO_EMISSOR VARCHAR(10) NOT NULL,
	DATA_NASCIMENTO DATE NOT NULL,
	LOCAL_NASCIMENTO VARCHAR(50) NOT NULL,
	NATURALIDADE ORIGEM NOT NULL,
	NOME_MAE VARCHAR(255) NOT NULL,
	NOME_PAI VARCHAR(255) 
);
-- INSERINDO RG
	INSERT INTO RG (numero, data_emissao, orgao_emissor, data_nascimento, local_nascimento, naturalidade,nome_mae, nome_pai, rg_cliente) 
	VALUES('9089988787','2008-03-22','SSP-PE','1988-03-08','OURICURI-PE','BRASILEIRO','MARIA DA PAZ','JOAO DA CONCEICAO');
--FIM DO INSERIR RG

CREATE SEQUENCE seq_id_end INCREMENT 1 MINVALUE 1 MAXVALUE 999999999999999999 START 1 CACHE 1;  
CREATE TABLE ENDERECO (
	IDENDERECO  INT PRIMARY KEY DEFAULT NEXTVAL('seq_id_end'),
	RUA VARCHAR(100)  NOT NULL,
	NUMERO VARCHAR(10) NOT NULL,
	BAIRRO VARCHAR(50) NOT NULL,
	CIDADE VARCHAR(50) NOT NULL,
	ESTADO CHAR(2) NOT NULL
);
-- INSERINDO ENDERECO
	INSERT INTO ENDERECO (RUA, NUMERO, BAIRRO, CIDADE, ESTADO, ENDERECO_CLIENTE) 
	VALUES('RUA JOAO PEREIRA DE CARVALHO','1485','CAMPO ALEGRE','JUAZEIRO DO NORTE','CE',1);
--FIM DO INSERIR ENDERECO

CREATE TYPE CURSAR AS ENUM('TEORICO','PRATICO','PRATICO/TEORICO');
CREATE TYPE SERVICO AS ENUM('1ª HABILITACAO','ADICAO','MUDANCA');
CREATE TYPE CAT AS ENUM('A','B','C','D','E','AB','AC','AD','AE');
CREATE SEQUENCE seq_id_catpret INCREMENT 1 MINVALUE 1 MAXVALUE 999999999999999999 START 1 CACHE 1; 
CREATE TABLE CATEGORIA_PRETENDIDA(
	IDCAT_PRET INT PRIMARY KEY DEFAULT NEXTVAL('seq_id_catpret'),
	CURSO  CURSAR NOT NULL,
	TIPO SERVICO NOT NULL,
	CATEGORIA CAT NOT NULL
);
-- INSERINDO CATEGORIA_PRETENDIDA
	INSERT INTO CATEGORIA_PRETENDIDA (CURSO, TIPO, CATEGORIA, CATEOGIA_CLIENTE) 
	VALUES('PRATICO/TEORICO','MUDANCA','E',1);
--FIM DO INSERIR CATEGORIA_PRETENDIDA

CREATE TYPE CONTATO AS ENUM('CELULAR','FIXO','COMERCIAL');
CREATE SEQUENCE seq_id_telefones INCREMENT 1 MINVALUE 1 MAXVALUE 999999999999999999 START 1 CACHE 1; 
CREATE TABLE TELEFONE (
	IDTELEFONE INT PRIMARY KEY DEFAULT NEXTVAL('seq_id_telefones'),
	TIPO CONTATO NOT NULL,
	NUMERO VARCHAR(15) NOT NULL
);
-- INSERINDO TELEFONE
	INSERT INTO TELEFONE (TIPO,NUMEO, CONTATO_CLIENTE) 
	VALUES('CELULAR','(88) 999859218',1);
--FIM DO INSERIR TELEFONE

--CRIANDO UMA PROCEDURE PARA A TABELA FORMA_PAGTO

CREATE FUNCTION GERA_DATA_HORA() RETURNS TRIGGER AS $$
BEGIN

	INSERT INTO FORMA_PAGTO (DATA_PAGTO) VALUES(NOW());
	RETURN NEW;

END;
$$ LANGUAGE 'plpgsql';

-- CRIANDO O GATILHO PARA A PROCEDURE

CREATE TRIGGER ADD_DATA_HORA
AFTER INSERT
FOR EACH ROW
EXECUTE PROCEDURE GERA_DATA_HORA();

CREATE TYPE FP AS ENUM('AVISTA','CARTAO','OUTROS');
CREATE SEQUENCE seq_id_pg INCREMENT 1 MINVALUE 1 MAXVALUE 999999999999999999 START 1 CACHE 1; 
CREATE TABLE FORMA_PAGTO(
	IDPAGTO INT PRIMARY KEY DEFAULT NEXTVAL('seq_id_pg'),
	FORMA FP NOT NULL,
	VALOR MONEY NOT NULL,
	DATA_PAGTO TIMESTAMP
	);
-- INSERINDO FORMA_PAGTO
	INSERT INTO FORMA_PAGTO (FORMA,VALOR, DATA_PAGTO, PAGTO_CLIENTE) 
	VALUES('AVISTA',1700,NOW(),1);
--FIM DO INSERIR FORMA_PAGTO

/* INSERINDO AS REFERENCIAS*/

ALTER TABLE RG ADD RG_CLIENTE INT NOT NULL;
ALTER TABLE RG ADD CONSTRAINT RG_CLIENTE_CLIENTE FOREIGN KEY (RG_CLIENTE) REFERENCES CLIENTE(IDCLIENTE);

ALTER TABLE ENDERECO ADD ENDERECO_CLIENTE INT NOT NULL;
ALTER TABLE ENDERECO ADD CONSTRAINT END_CLIENTE_CLIENTE FOREIGN KEY (ENDERECO_CLIENTE) REFERENCES CLIENTE(IDCLIENTE);

ALTER TABLE CATEGORIA_PRETENDIDA ADD CATEGORIA_CLIENTE INT NOT NULL;
ALTER TABLE CATEGORIA_PRETENDIDA ADD CONSTRAINT CAT_CLIENTE_CLIENTE FOREIGN KEY (CATEGORIA_CLIENTE) REFERENCES CLIENTE(IDCLIENTE);

ALTER TABLE TELEFONE ADD CONTATO_CLIENTE INT NOT NULL;
ALTER TABLE TELEFONE ADD CONSTRAINT CONTATO_CLIENTE_CLIENTE FOREIGN KEY (CONTATO_CLIENTE) REFERENCES CLIENTE(IDCLIENTE);

ALTER TABLE FORMA_PAGTO ADD PAGTO_CLIENTE INT NOT NULL;
ALTER TABLE FORMA_PAGTO ADD CONSTRAINT PG_CLIENTE_CLIENTE FOREIGN KEY (PAGTO_CLIENTE) REFERENCES CLIENTE(IDCLIENTE);

--JUNTANDO TODAS AS TABELAS NO SELECT, TESTANDO.
SELECT C.NOME, C.SOBRENOME,C.CPF,R.NUMERO AS IDENTIDADE,R.NOME_MAE AS "Filho de",E.RUA as Logradouro,E.NUMERO,E.BAIRRO,T.NUMERO AS TELEFONE,
		CP.TIPO AS CATEGORIA,FP.FORMA as Pagamento,FP.VALOR FROM CLIENTE C
		INNER JOIN RG R ON R.RG_CLIENTE = C.IDCLIENTE
		INNER JOIN ENDERECO E ON E.ENDERECO_CLIENTE = C.IDCLIENTE
		INNER JOIN TELEFONE T ON T.CONTATO_CLIENTE = C.IDCLIENTE
		INNER JOIN CATEGORIA_PRETENDIDA CP ON CP.CATEGORIA_CLIENTE = C.IDCLIENTE
		INNER JOIN FORMA_PAGTO FP ON FP.PAGTO_CLIENTE = C.IDCLIENTE;
-- FIM DA JUNÇÃO